<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- SEO Meta Tags -->
    <title>Estimation immobili√®re gratuite | ValoMaison</title>
    <meta name="description" content="Estimez gratuitement la valeur de votre bien immobilier en 2 minutes. Bas√© sur les transactions r√©elles DVF.">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="{{ request.url_root }}estimation">

    <!-- Open Graph -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="{{ request.url_root }}estimation">
    <meta property="og:title" content="Estimation immobili√®re gratuite | ValoMaison">
    <meta property="og:description" content="Estimez gratuitement la valeur de votre bien immobilier en 2 minutes.">
    <meta property="og:locale" content="fr_FR">

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üè†</text></svg>">

    <!-- Fonts & Styles -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="app">
        <!-- Navigation -->
        <nav class="navbar">
            <a href="/" class="nav-logo">
                <span class="logo-icon">üè†</span>
                <span class="logo-text">ValoMaison</span>
            </a>
            <button class="nav-toggle" aria-label="Menu">‚ò∞</button>
            <div class="nav-links">
                <a href="/" class="nav-link">Accueil</a>
                <a href="/estimation" class="nav-link active">Estimer</a>
                <a href="/a-propos" class="nav-link">√Ä propos</a>
                <a href="/contact" class="nav-link">Contact</a>
            </div>
        </nav>

        <!-- Page Header -->
        <header class="page-header">
            <h1>Estimez votre bien immobilier</h1>
            <p>Obtenez une estimation bas√©e sur les transactions r√©elles en quelques clics</p>
        </header>

        <!-- Main Form -->
        <main class="main-content">
            <form id="estimation-form" class="estimation-form multistep-form">
                <!-- Progress Stepper -->
                <div class="form-stepper">
                    <div class="stepper-step active" data-step="1">
                        <span class="stepper-number">1</span>
                        <span class="stepper-label">Bien</span>
                    </div>
                    <div class="stepper-line"></div>
                    <div class="stepper-step" data-step="2">
                        <span class="stepper-number">2</span>
                        <span class="stepper-label">Surface</span>
                    </div>
                    <div class="stepper-line"></div>
                    <div class="stepper-step" data-step="3">
                        <span class="stepper-number">3</span>
                        <span class="stepper-label">√âtat</span>
                    </div>
                    <div class="stepper-line"></div>
                    <div class="stepper-step" data-step="4">
                        <span class="stepper-number">4</span>
                        <span class="stepper-label">Options</span>
                    </div>
                    <div class="stepper-line"></div>
                    <div class="stepper-step" data-step="5">
                        <span class="stepper-number">5</span>
                        <span class="stepper-label">Projet</span>
                    </div>
                    <div class="stepper-line" id="stepper-line-6"></div>
                    <div class="stepper-step" data-step="6" id="stepper-step-6">
                        <span class="stepper-number">6</span>
                        <span class="stepper-label">Contact</span>
                    </div>
                </div>

                <!-- Step 1: Type & Location -->
                <div class="form-step active" data-step="1">
                    <div class="form-card">
                        <div class="card-header">
                            <span class="step-number">1</span>
                            <div>
                                <h2>Votre bien</h2>
                                <p>Type et localisation</p>
                            </div>
                        </div>

                        <div class="type-selector">
                            <label class="type-option selected" data-type="appartement">
                                <input type="radio" name="type_bien" value="appartement" checked>
                                <span class="type-icon">üè¢</span>
                                <span class="type-label">Appartement</span>
                            </label>
                            <label class="type-option" data-type="maison">
                                <input type="radio" name="type_bien" value="maison">
                                <span class="type-icon">üè°</span>
                                <span class="type-label">Maison</span>
                            </label>
                        </div>

                        <div class="input-group">
                            <label for="code_postal">Code postal</label>
                            <input type="text" id="code_postal" name="code_postal"
                                   placeholder="Ex: 75001" pattern="[0-9]{5}" maxlength="5" required>
                        </div>
                    </div>

                    <div class="step-navigation">
                        <div></div>
                        <button type="button" class="nav-btn nav-btn-next" onclick="nextStep()">
                            Suivant <span>‚Üí</span>
                        </button>
                    </div>
                </div>

                <!-- Step 2: Surface & Rooms -->
                <div class="form-step" data-step="2">
                    <div class="form-card">
                        <div class="card-header">
                            <span class="step-number">2</span>
                            <div>
                                <h2>Caract√©ristiques</h2>
                                <p>Surface et pi√®ces</p>
                            </div>
                        </div>

                        <div class="input-row">
                            <div class="input-group">
                                <label for="surface">Surface (m¬≤)</label>
                                <input type="number" id="surface" name="surface"
                                       placeholder="Ex: 65" min="9" max="1000" required>
                            </div>
                            <div class="input-group">
                                <label for="nb_pieces">Pi√®ces</label>
                                <input type="number" id="nb_pieces" name="nb_pieces"
                                       placeholder="Ex: 3" min="1" max="20" required>
                            </div>
                        </div>

                        <!-- Appartement specific -->
                        <div id="appart-fields" class="conditional-fields">
                            <div class="input-row">
                                <div class="input-group">
                                    <label for="etage">√âtage</label>
                                    <input type="number" id="etage" name="etage"
                                           placeholder="Ex: 3" min="0" max="50">
                                </div>
                                <div class="input-group">
                                    <label for="nb_etages_immeuble">√âtages immeuble</label>
                                    <input type="number" id="nb_etages_immeuble" name="nb_etages_immeuble"
                                           placeholder="Ex: 5" min="1" max="50">
                                </div>
                            </div>
                        </div>

                        <!-- Maison specific -->
                        <div id="maison-fields" class="conditional-fields hidden">
                            <div class="input-group">
                                <label for="surface_terrain">Surface terrain (m¬≤)</label>
                                <input type="number" id="surface_terrain" name="surface_terrain"
                                       placeholder="Ex: 500" min="0" max="100000">
                            </div>
                        </div>
                    </div>

                    <div class="step-navigation">
                        <button type="button" class="nav-btn nav-btn-prev" onclick="prevStep()">
                            <span>‚Üê</span> Pr√©c√©dent
                        </button>
                        <button type="button" class="nav-btn nav-btn-next" onclick="nextStep()">
                            Suivant <span>‚Üí</span>
                        </button>
                    </div>
                </div>

                <!-- Step 3: State -->
                <div class="form-step" data-step="3">
                    <div class="form-card">
                        <div class="card-header">
                            <span class="step-number">3</span>
                            <div>
                                <h2>√âtat du bien</h2>
                                <p>Affinez votre estimation</p>
                            </div>
                        </div>

                        <div class="input-row">
                            <div class="input-group">
                                <label for="etat_general">√âtat g√©n√©ral</label>
                                <select id="etat_general" name="etat_general">
                                    <option value="a_renover">√Ä r√©nover</option>
                                    <option value="correct">Correct</option>
                                    <option value="bon" selected>Bon √©tat</option>
                                    <option value="tres_bon">Tr√®s bon √©tat</option>
                                    <option value="neuf">Neuf / Refait √† neuf</option>
                                </select>
                            </div>
                            <div class="input-group">
                                <label for="dpe">DPE</label>
                                <select id="dpe" name="dpe">
                                    <option value="">Non renseign√©</option>
                                    <option value="A">A - Excellent</option>
                                    <option value="B">B - Tr√®s bon</option>
                                    <option value="C">C - Bon</option>
                                    <option value="D">D - Moyen</option>
                                    <option value="E">E - Passable</option>
                                    <option value="F">F - Mauvais</option>
                                    <option value="G">G - Tr√®s mauvais</option>
                                </select>
                            </div>
                        </div>

                        <div class="input-row">
                            <div class="input-group">
                                <label for="exposition">Exposition</label>
                                <select id="exposition" name="exposition">
                                    <option value="">Non renseign√©</option>
                                    <option value="nord">Nord</option>
                                    <option value="est">Est</option>
                                    <option value="ouest">Ouest</option>
                                    <option value="sud">Sud</option>
                                </select>
                            </div>
                            <div class="input-group">
                                <label for="vue">Vue</label>
                                <select id="vue" name="vue">
                                    <option value="">Non renseign√©</option>
                                    <option value="vis_a_vis">Vis-√†-vis</option>
                                    <option value="degagee">D√©gag√©e</option>
                                    <option value="exceptionnelle">Exceptionnelle</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="step-navigation">
                        <button type="button" class="nav-btn nav-btn-prev" onclick="prevStep()">
                            <span>‚Üê</span> Pr√©c√©dent
                        </button>
                        <button type="button" class="nav-btn nav-btn-next" onclick="nextStep()">
                            Suivant <span>‚Üí</span>
                        </button>
                    </div>
                </div>

                <!-- Step 4: Equipment & Options -->
                <div class="form-step" data-step="4">
                    <div class="form-card">
                        <div class="card-header">
                            <span class="step-number">4</span>
                            <div>
                                <h2>√âquipements</h2>
                                <p>Optionnel - S√©lectionnez ce qui s'applique</p>
                            </div>
                        </div>

                        <div class="input-group">
                            <label for="standing">Standing</label>
                            <select id="standing" name="standing">
                                <option value="economique">√âconomique</option>
                                <option value="standard" selected>Standard</option>
                                <option value="standing">Standing</option>
                                <option value="luxe">Luxe</option>
                            </select>
                        </div>

                        <p class="checkbox-section-title">Espaces & Rangements</p>
                        <div class="checkbox-grid">
                            <label class="checkbox-card" id="ascenseur-option">
                                <input type="checkbox" name="ascenseur" value="true">
                                <span class="checkbox-icon">üõó</span>
                                <span class="checkbox-label">Ascenseur</span>
                            </label>
                            <label class="checkbox-card">
                                <input type="checkbox" name="balcon_terrasse" value="true">
                                <span class="checkbox-icon">üåÖ</span>
                                <span class="checkbox-label">Balcon/Terrasse</span>
                            </label>
                            <label class="checkbox-card">
                                <input type="checkbox" name="parking" value="true">
                                <span class="checkbox-icon">üöó</span>
                                <span class="checkbox-label">Parking</span>
                            </label>
                            <label class="checkbox-card">
                                <input type="checkbox" name="cave" value="true">
                                <span class="checkbox-icon">üì¶</span>
                                <span class="checkbox-label">Cave</span>
                            </label>
                            <label class="checkbox-card" id="jardin-option">
                                <input type="checkbox" name="jardin" value="true">
                                <span class="checkbox-icon">üåø</span>
                                <span class="checkbox-label">Jardin</span>
                            </label>
                            <label class="checkbox-card" id="veranda-option" style="display: none;">
                                <input type="checkbox" name="veranda" value="true">
                                <span class="checkbox-icon">üè†</span>
                                <span class="checkbox-label">V√©randa</span>
                            </label>
                            <label class="checkbox-card" id="dependances-option" style="display: none;">
                                <input type="checkbox" name="dependances" value="true">
                                <span class="checkbox-icon">üèöÔ∏è</span>
                                <span class="checkbox-label">D√©pendances</span>
                            </label>
                        </div>

                        <p class="checkbox-section-title">Confort & S√©curit√©</p>
                        <div class="checkbox-grid">
                            <label class="checkbox-card">
                                <input type="checkbox" name="cuisine_equipee" value="true">
                                <span class="checkbox-icon">üç≥</span>
                                <span class="checkbox-label">Cuisine √©quip√©e</span>
                            </label>
                            <label class="checkbox-card">
                                <input type="checkbox" name="double_vitrage" value="true">
                                <span class="checkbox-icon">ü™ü</span>
                                <span class="checkbox-label">Double vitrage</span>
                            </label>
                            <label class="checkbox-card">
                                <input type="checkbox" name="climatisation" value="true">
                                <span class="checkbox-icon">‚ùÑÔ∏è</span>
                                <span class="checkbox-label">Climatisation</span>
                            </label>
                            <label class="checkbox-card">
                                <input type="checkbox" name="cheminee" value="true">
                                <span class="checkbox-icon">üî•</span>
                                <span class="checkbox-label">Chemin√©e</span>
                            </label>
                            <label class="checkbox-card">
                                <input type="checkbox" name="parquet" value="true">
                                <span class="checkbox-icon">ü™µ</span>
                                <span class="checkbox-label">Parquet</span>
                            </label>
                            <label class="checkbox-card">
                                <input type="checkbox" name="fibre" value="true">
                                <span class="checkbox-icon">üì°</span>
                                <span class="checkbox-label">Fibre optique</span>
                            </label>
                            <label class="checkbox-card">
                                <input type="checkbox" name="alarme" value="true">
                                <span class="checkbox-icon">üö®</span>
                                <span class="checkbox-label">Alarme</span>
                            </label>
                            <label class="checkbox-card">
                                <input type="checkbox" name="digicode" value="true">
                                <span class="checkbox-icon">üîê</span>
                                <span class="checkbox-label">Digicode</span>
                            </label>
                            <label class="checkbox-card">
                                <input type="checkbox" name="gardien" value="true">
                                <span class="checkbox-icon">üëÆ</span>
                                <span class="checkbox-label">Gardien</span>
                            </label>
                            <label class="checkbox-card" id="portail-option" style="display: none;">
                                <input type="checkbox" name="portail_auto" value="true">
                                <span class="checkbox-icon">üöß</span>
                                <span class="checkbox-label">Portail auto</span>
                            </label>
                        </div>

                        <!-- Maison premium features -->
                        <div id="maison-premium" class="hidden">
                            <p class="checkbox-section-title">Ext√©rieur & Loisirs</p>
                            <div class="checkbox-grid">
                                <label class="checkbox-card">
                                    <input type="checkbox" name="piscine" value="true">
                                    <span class="checkbox-icon">üèä</span>
                                    <span class="checkbox-label">Piscine</span>
                                </label>
                                <label class="checkbox-card">
                                    <input type="checkbox" name="potager" value="true">
                                    <span class="checkbox-icon">ü•ï</span>
                                    <span class="checkbox-label">Potager</span>
                                </label>
                                <label class="checkbox-card">
                                    <input type="checkbox" name="spa" value="true">
                                    <span class="checkbox-icon">üõÅ</span>
                                    <span class="checkbox-label">Spa/Jacuzzi</span>
                                </label>
                                <label class="checkbox-card">
                                    <input type="checkbox" name="terrain_tennis" value="true">
                                    <span class="checkbox-icon">üéæ</span>
                                    <span class="checkbox-label">Tennis</span>
                                </label>
                                <label class="checkbox-card">
                                    <input type="checkbox" name="abri_jardin" value="true">
                                    <span class="checkbox-icon">üè°</span>
                                    <span class="checkbox-label">Abri de jardin</span>
                                </label>
                                <label class="checkbox-card">
                                    <input type="checkbox" name="arrosage_auto" value="true">
                                    <span class="checkbox-icon">üíß</span>
                                    <span class="checkbox-label">Arrosage auto</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="step-navigation">
                        <button type="button" class="nav-btn nav-btn-prev" onclick="prevStep()">
                            <span>‚Üê</span> Pr√©c√©dent
                        </button>
                        <button type="button" class="nav-btn nav-btn-next" onclick="nextStep()">
                            Suivant <span>‚Üí</span>
                        </button>
                    </div>
                </div>

                <!-- Step 5: Quand vendez-vous ? -->
                <div class="form-step" data-step="5">
                    <div class="form-card">
                        <div class="card-header">
                            <span class="step-number">5</span>
                            <div>
                                <h2>Votre projet</h2>
                                <p>Quand souhaitez-vous vendre ?</p>
                            </div>
                        </div>

                        <div class="type-selector selling-timeline">
                            <label class="type-option timeline-option" data-timeline="moins_3_mois">
                                <input type="radio" name="quand_vendre" value="moins_3_mois">
                                <span class="type-icon">üöÄ</span>
                                <span class="type-label">Moins de 3 mois</span>
                            </label>
                            <label class="type-option timeline-option" data-timeline="3_6_mois">
                                <input type="radio" name="quand_vendre" value="3_6_mois">
                                <span class="type-icon">üìÖ</span>
                                <span class="type-label">3 √† 6 mois</span>
                            </label>
                            <label class="type-option timeline-option" data-timeline="6_12_mois">
                                <input type="radio" name="quand_vendre" value="6_12_mois">
                                <span class="type-icon">üìÜ</span>
                                <span class="type-label">6 √† 12 mois</span>
                            </label>
                            <label class="type-option timeline-option" data-timeline="curieux">
                                <input type="radio" name="quand_vendre" value="curieux">
                                <span class="type-icon">üîç</span>
                                <span class="type-label">Juste curieux</span>
                            </label>
                        </div>
                    </div>

                    <div class="step-navigation">
                        <button type="button" class="nav-btn nav-btn-prev" onclick="prevStep()">
                            <span>‚Üê</span> Pr√©c√©dent
                        </button>
                        <button type="button" class="nav-btn nav-btn-next" id="step5-next-btn" onclick="handleStep5Next()" disabled>
                            Suivant <span>‚Üí</span>
                        </button>
                    </div>
                </div>

                <!-- Step 6: Formulaire de capture -->
                <div class="form-step" data-step="6">
                    <div class="form-card">
                        <div class="card-header">
                            <span class="step-number">6</span>
                            <div>
                                <h2>Vos coordonn√©es</h2>
                                <p>Recevez votre estimation d√©taill√©e</p>
                            </div>
                        </div>

                        <div class="capture-intro">
                            <p>Renseignez vos coordonn√©es pour recevoir des conseils personnalis√©s de nos experts</p>
                        </div>
                        <div class="input-group">
                            <label for="lead-nom">Nom *</label>
                            <input type="text" id="lead-nom" name="lead_nom" placeholder="Votre nom">
                        </div>
                        <div class="input-group">
                            <label for="lead-email">Email *</label>
                            <input type="email" id="lead-email" name="lead_email" placeholder="votre@email.com">
                        </div>
                        <div class="input-group">
                            <label for="lead-telephone">T√©l√©phone *</label>
                            <input type="tel" id="lead-telephone" name="lead_telephone" placeholder="06 12 34 56 78"
                                   pattern="^(\+33|0)[1-9](\s?[0-9]{2}){4}$"
                                   title="Format: 0612345678 ou +33612345678">
                        </div>
                        <label class="consent-checkbox">
                            <input type="checkbox" id="lead-consent" name="lead_consent">
                            <span>J'accepte d'√™tre recontact√© par ValoMaison. <a href="/politique-confidentialite" target="_blank">Politique de confidentialit√©</a></span>
                        </label>
                    </div>

                    <div class="step-navigation">
                        <button type="button" class="nav-btn nav-btn-prev" onclick="prevStep()">
                            <span>‚Üê</span> Pr√©c√©dent
                        </button>
                        <button type="submit" class="submit-btn">
                            <span class="btn-text">Voir mon estimation</span>
                            <span class="btn-icon">‚Üí</span>
                        </button>
                    </div>
                </div>
            </form>

            <!-- Results Section -->
            <div id="results" class="results-section hidden">
                <div class="results-card">
                    <div class="results-header">
                        <h2>Estimation de votre bien</h2>
                        <button type="button" class="close-btn" onclick="closeResults()">√ó</button>
                    </div>

                    <div id="zone-info" class="zone-alert hidden">
                        <span class="zone-icon">i</span>
                        <span id="zone-message"></span>
                    </div>

                    <div class="price-display">
                        <div class="price-range">
                            <div class="price-item price-low">
                                <span class="price-label">Estimation basse</span>
                                <span class="price-value" id="result-low"><span class="skeleton skeleton-price"></span></span>
                            </div>
                            <div class="price-item price-main">
                                <span class="price-label">Estimation</span>
                                <span class="price-value" id="result-mid"><span class="skeleton skeleton-price-main"></span></span>
                                <span class="price-badge">Valeur probable</span>
                            </div>
                            <div class="price-item price-high">
                                <span class="price-label">Estimation haute</span>
                                <span class="price-value" id="result-high"><span class="skeleton skeleton-price"></span></span>
                            </div>
                        </div>
                    </div>

                    <div class="details-grid">
                        <div class="detail-card">
                            <span class="detail-icon">üìä</span>
                            <span class="detail-label">Prix/m¬≤ zone</span>
                            <span class="detail-value" id="result-price-zone"><span class="skeleton skeleton-detail"></span></span>
                        </div>
                        <div class="detail-card">
                            <span class="detail-icon">üéØ</span>
                            <span class="detail-label">Prix/m¬≤ ajust√©</span>
                            <span class="detail-value" id="result-price-adjusted"><span class="skeleton skeleton-detail"></span></span>
                        </div>
                        <div class="detail-card">
                            <span class="detail-icon">üìà</span>
                            <span class="detail-label">Ajustement</span>
                            <span class="detail-value" id="result-adjustment"><span class="skeleton skeleton-detail"></span></span>
                        </div>
                        <div class="detail-card">
                            <span class="detail-icon">üèòÔ∏è</span>
                            <span class="detail-label">Transactions</span>
                            <span class="detail-value" id="result-transactions"><span class="skeleton skeleton-detail"></span></span>
                        </div>
                        <div class="detail-card">
                            <span class="detail-icon">‚≠ê</span>
                            <span class="detail-label">Confiance</span>
                            <span class="detail-value" id="result-confidence"><span class="skeleton skeleton-detail"></span></span>
                        </div>
                    </div>

                    <details class="adjustments-details">
                        <summary>Voir le detail des ajustements</summary>
                        <ul id="adjustments-list" class="adjustments-list"></ul>
                    </details>

                    <div class="disclaimer">
                        <strong>Note :</strong> Cette estimation est bas√©e sur les donn√©es DVF
                        (transactions r√©elles). Elle est indicative et ne remplace pas l'avis d'un professionnel.
                    </div>

                    <button type="button" class="new-estimation-btn" onclick="newEstimation()">
                        Nouvelle estimation
                    </button>
                </div>

                <!-- Conversion Section (shown first) -->
                <div id="conversion-section" class="conversion-section hidden">
                    <div class="conversion-card">
                        <!-- Estimation Preview -->
                        <div class="estimation-ready-banner">
                            <div class="ready-icon">‚úì</div>
                            <div class="ready-text">
                                <h2>Votre estimation est pr√™te !</h2>
                                <p>Valeur estim√©e de votre bien</p>
                            </div>
                        </div>

                        <div class="estimation-preview">
                            <div class="preview-price" id="preview-price">--- --- ‚Ç¨</div>
                            <div class="preview-blur-overlay">
                                <span>üîí</span>
                            </div>
                        </div>

                        <!-- Upsell Section -->
                        <div class="upsell-section">
                            <h3>üìà Optimisez votre estimation gratuitement</h3>
                            <p>Un conseiller expert peut affiner ce r√©sultat et vous faire gagner en moyenne <strong>+8%</strong> sur le prix de vente.</p>

                            <div class="upsell-benefits">
                                <div class="benefit-item">
                                    <span class="benefit-check">‚úì</span>
                                    <span>Analyse personnalis√©e de votre bien</span>
                                </div>
                                <div class="benefit-item">
                                    <span class="benefit-check">‚úì</span>
                                    <span>Conseils pour maximiser la valeur</span>
                                </div>
                                <div class="benefit-item">
                                    <span class="benefit-check">‚úì</span>
                                    <span>100% gratuit, sans engagement</span>
                                </div>
                            </div>

                            <div id="cta-options" class="cta-options">
                                <button type="button" class="cta-card cta-primary" onclick="showCallbackForm()">
                                    <span class="cta-icon">üìû</span>
                                    <div class="cta-content">
                                        <strong>√ätre rappel√©</strong>
                                        <span>Par un expert immobilier</span>
                                    </div>
                                </button>
                                <button type="button" class="cta-card" onclick="showVisitForm()">
                                    <span class="cta-icon">üè†</span>
                                    <div class="cta-content">
                                        <strong>Visite gratuite</strong>
                                        <span>Estimation √† domicile</span>
                                    </div>
                                </button>
                            </div>
                        </div>

                        <button type="button" id="skip-conversion-btn" class="skip-btn" onclick="skipToEstimation()">
                            Non merci, voir directement mon estimation ‚Üí
                        </button>

                    <!-- Callback Form -->
                    <div id="callback-form-container" class="lead-form-container hidden">
                        <button type="button" class="back-btn" onclick="hideLeadForms()">Retour</button>
                        <h4>Demande de rappel</h4>
                        <p>Un conseiller vous contactera pour r√©pondre √† vos questions.</p>
                        <form id="callback-form" class="lead-form">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="callback-nom">Nom *</label>
                                    <input type="text" id="callback-nom" name="nom" required>
                                </div>
                                <div class="form-group">
                                    <label for="callback-prenom">Pr√©nom *</label>
                                    <input type="text" id="callback-prenom" name="prenom" required>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="callback-tel">T√©l√©phone *</label>
                                <input type="tel" id="callback-tel" name="telephone" placeholder="06 12 34 56 78"
                                       pattern="^(\+33|0)[1-9](\s?[0-9]{2}){4}$"
                                       title="Format: 0612345678 ou +33612345678" required>
                            </div>
                            <div class="form-group">
                                <label for="callback-email">Email</label>
                                <input type="email" id="callback-email" name="email" placeholder="optionnel">
                            </div>
                            <div class="form-group">
                                <label for="callback-horaires">Horaires de disponibilit√©</label>
                                <select id="callback-horaires" name="horaires">
                                    <option value="matin">Le matin (9h-12h)</option>
                                    <option value="midi">Le midi (12h-14h)</option>
                                    <option value="aprem" selected>L'apr√®s-midi (14h-18h)</option>
                                    <option value="soir">En soir√©e (18h-20h)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="callback-projet">Votre projet</label>
                                <select id="callback-projet" name="projet">
                                    <option value="vente">Je souhaite vendre</option>
                                    <option value="estimation">Simple curiosit√© / estimation</option>
                                    <option value="succession">Succession / Partage</option>
                                    <option value="investissement">Projet d'investissement</option>
                                </select>
                            </div>
                            <label class="consent-checkbox">
                                <input type="checkbox" name="consent" required>
                                <span>J'accepte d'√™tre recontact√© par ValoMaison. <a href="/politique-confidentialite" target="_blank">Politique de confidentialit√©</a></span>
                            </label>
                            <button type="submit" class="btn-primary btn-full">Demander un rappel</button>
                        </form>
                    </div>

                    <!-- Visit Form -->
                    <div id="visit-form-container" class="lead-form-container hidden">
                        <button type="button" class="back-btn" onclick="hideLeadForms()">Retour</button>
                        <h4>Planifier une visite d'estimation</h4>
                        <p>Un conseiller se d√©place gratuitement pour √©valuer votre bien sur place.</p>
                        <form id="visit-form" class="lead-form">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="visit-nom">Nom *</label>
                                    <input type="text" id="visit-nom" name="nom" required>
                                </div>
                                <div class="form-group">
                                    <label for="visit-prenom">Pr√©nom *</label>
                                    <input type="text" id="visit-prenom" name="prenom" required>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="visit-tel">T√©l√©phone *</label>
                                    <input type="tel" id="visit-tel" name="telephone" placeholder="06 12 34 56 78"
                                           pattern="^(\+33|0)[1-9](\s?[0-9]{2}){4}$"
                                           title="Format: 0612345678 ou +33612345678" required>
                                </div>
                                <div class="form-group">
                                    <label for="visit-email">Email *</label>
                                    <input type="email" id="visit-email" name="email" required>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="visit-adresse">Adresse du bien *</label>
                                <input type="text" id="visit-adresse" name="adresse" placeholder="Rue, num√©ro" required>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="visit-date">Date souhait√©e *</label>
                                    <input type="date" id="visit-date" name="date" required>
                                </div>
                                <div class="form-group">
                                    <label for="visit-creneau">Cr√©neau</label>
                                    <select id="visit-creneau" name="creneau">
                                        <option value="matin">Matin (9h-12h)</option>
                                        <option value="aprem" selected>Apr√®s-midi (14h-18h)</option>
                                        <option value="soir">Soir√©e (18h-20h)</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="visit-message">Message (optionnel)</label>
                                <textarea id="visit-message" name="message" rows="3" placeholder="Informations compl√©mentaires sur votre bien ou votre projet..."></textarea>
                            </div>
                            <label class="consent-checkbox">
                                <input type="checkbox" name="consent" required>
                                <span>J'accepte d'√™tre recontact√© par ValoMaison. <a href="/politique-confidentialite" target="_blank">Politique de confidentialit√©</a></span>
                            </label>
                            <button type="submit" class="btn-primary btn-full">Planifier la visite</button>
                        </form>
                    </div>

                    <!-- Success Message -->
                    <div id="lead-success" class="lead-success hidden">
                        <div class="success-content">
                            <span class="success-icon-large">‚úì</span>
                            <h4>Demande envoy√©e !</h4>
                            <p id="success-message">Un conseiller vous contactera tr√®s prochainement.</p>
                        </div>
                    </div>

                    <p class="trust-note">Plus de 500 propri√©taires accompagn√©s cette ann√©e</p>
                </div>
            </div>

            <!-- Error Section -->
            <div id="error-message" class="error-section hidden">
                <div class="error-card">
                    <span class="error-icon">!</span>
                    <p id="error-text"></p>
                    <button type="button" onclick="closeError()">Reessayer</button>
                </div>
            </div>

            <!-- Loading -->
            <div id="loading" class="loading-overlay hidden">
                <div class="loading-content">
                    <div class="loading-house">
                        <div class="house-icon">üè†</div>
                        <div class="loading-bar">
                            <div class="loading-progress"></div>
                        </div>
                    </div>
                    <p class="loading-text">Analyse des transactions en cours...</p>
                    <p class="loading-subtext">Calcul de l'estimation bas√©e sur les ventes r√©elles</p>
                </div>
            </div>
        </main>

        <footer class="site-footer">
            <div class="footer-content">
                <div class="footer-brand">
                    <span class="logo-icon">üè†</span>
                    <span class="logo-text">ValoMaison</span>
                </div>
                <div class="footer-links">
                    <a href="/">Accueil</a>
                    <a href="/estimation">Estimer</a>
                    <a href="/a-propos">A propos</a>
                    <a href="/contact">Contact</a>
                </div>
                <div class="footer-legal-links">
                    <a href="/mentions-legales">Mentions legales</a>
                    <a href="/cgu">CGU</a>
                    <a href="/politique-confidentialite">Confidentialite</a>
                </div>
                <p class="footer-legal">Donnees DVF - data.gouv.fr</p>
            </div>
        </footer>
    </div>

    <script>
        // Multi-step form navigation
        let currentStep = 1;
        const totalSteps = 6;

        // Logging helper
        function log(message, data = null) {
            const timestamp = new Date().toISOString().substr(11, 12);
            if (data) {
                console.log(`[${timestamp}] [Estimation] ${message}`, data);
            } else {
                console.log(`[${timestamp}] [Estimation] ${message}`);
            }
        }

        log('Formulaire multi-step initialis√©');

        // Tracker l'√©tape initiale au chargement
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(function() {
                if (window.EITracker && window.EITracker.trackFormStep) {
                    window.EITracker.trackFormStep(1, 'Type & Localisation (start)', {});
                }
            }, 500);
        });

        function updateStepper() {
            document.querySelectorAll('.stepper-step').forEach((step, index) => {
                const stepNum = index + 1;
                step.classList.remove('active', 'completed');
                if (stepNum === currentStep) {
                    step.classList.add('active');
                } else if (stepNum < currentStep) {
                    step.classList.add('completed');
                }
            });

            // Update stepper lines
            document.querySelectorAll('.stepper-line').forEach((line, index) => {
                if (index < currentStep - 1) {
                    line.classList.add('completed');
                } else {
                    line.classList.remove('completed');
                }
            });
            log(`Stepper mis √† jour - √âtape ${currentStep}/${totalSteps}`);
        }

        const stepNames = {
            1: 'Type & Localisation',
            2: 'Caract√©ristiques',
            3: '√âtat du bien',
            4: '√âquipements',
            5: 'Projet de vente',
            6: 'Coordonn√©es'
        };

        function showStep(step) {
            document.querySelectorAll('.form-step').forEach(s => s.classList.remove('active'));
            const targetStep = document.querySelector(`.form-step[data-step="${step}"]`);
            if (targetStep) {
                targetStep.classList.add('active');
                log(`Affichage √©tape ${step}`);
            }
            updateStepper();

            // Tracker l'√©tape (fonctionne m√™me sans consentement cookies)
            if (window.EITracker && window.EITracker.trackFormStep) {
                const stepData = collectStepData(step);
                window.EITracker.trackFormStep(step, stepNames[step] || 'unknown', stepData);
            }

            // Scroll to top of form
            document.querySelector('.form-stepper').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function getStepValidationRules(step) {
            const rules = {
                1: [
                    { id: 'code_postal', name: 'Code postal', required: true, pattern: /^[0-9]{5}$/, message: 'Le code postal doit contenir 5 chiffres' }
                ],
                2: [
                    { id: 'surface', name: 'Surface', required: true, min: 9, max: 1000, message: 'La surface doit √™tre entre 9 et 1000 m¬≤' },
                    { id: 'nb_pieces', name: 'Nombre de pi√®ces', required: true, min: 1, max: 20, message: 'Le nombre de pi√®ces doit √™tre entre 1 et 20' }
                ],
                3: [], // Pas de champs obligatoires
                4: []  // Pas de champs obligatoires
            };
            return rules[step] || [];
        }

        function validateStep(step) {
            log(`Validation √©tape ${step}...`);
            const rules = getStepValidationRules(step);
            let isValid = true;
            let errors = [];

            // Remove previous error messages
            document.querySelectorAll('.field-error').forEach(el => el.remove());

            rules.forEach(rule => {
                const input = document.getElementById(rule.id);
                if (!input) return;

                const value = input.value.trim();
                let fieldValid = true;
                let errorMessage = '';

                // Check required
                if (rule.required && !value) {
                    fieldValid = false;
                    errorMessage = `${rule.name} est obligatoire`;
                }
                // Check pattern
                else if (rule.pattern && value && !rule.pattern.test(value)) {
                    fieldValid = false;
                    errorMessage = rule.message;
                }
                // Check min/max for numbers
                else if ((rule.min !== undefined || rule.max !== undefined) && value) {
                    const numValue = parseFloat(value);
                    if (rule.min !== undefined && numValue < rule.min) {
                        fieldValid = false;
                        errorMessage = rule.message;
                    }
                    if (rule.max !== undefined && numValue > rule.max) {
                        fieldValid = false;
                        errorMessage = rule.message;
                    }
                }

                if (!fieldValid) {
                    isValid = false;
                    errors.push({ field: rule.id, message: errorMessage });
                    input.classList.add('invalid');

                    // Add error message below input
                    const errorEl = document.createElement('span');
                    errorEl.className = 'field-error';
                    errorEl.textContent = errorMessage;
                    input.parentNode.appendChild(errorEl);

                    log(`Erreur validation: ${rule.id}`, errorMessage);
                } else {
                    input.classList.remove('invalid');
                }
            });

            if (isValid) {
                // Log validated data
                const stepData = collectStepData(step);
                log(`√âtape ${step} valid√©e`, stepData);
            } else {
                log(`√âtape ${step} - Erreurs de validation`, errors);
                // Focus first invalid field
                const firstError = errors[0];
                if (firstError) {
                    document.getElementById(firstError.field)?.focus();
                }
            }

            return isValid;
        }

        function collectStepData(step) {
            const stepElement = document.querySelector(`.form-step[data-step="${step}"]`);
            const data = {};

            stepElement.querySelectorAll('input, select').forEach(input => {
                if (input.type === 'radio') {
                    if (input.checked) data[input.name] = input.value;
                } else if (input.type === 'checkbox') {
                    if (input.checked) data[input.name] = true;
                } else if (input.value) {
                    data[input.name] = input.value;
                }
            });

            return data;
        }

        function nextStep() {
            log(`Tentative passage √©tape ${currentStep} -> ${currentStep + 1}`);
            if (currentStep < totalSteps) {
                if (validateStep(currentStep)) {
                    currentStep++;
                    showStep(currentStep);
                    log(`Navigation vers √©tape ${currentStep} r√©ussie`);
                }
            }
        }

        function prevStep() {
            log(`Retour √©tape ${currentStep} -> ${currentStep - 1}`);
            if (currentStep > 1) {
                currentStep--;
                showStep(currentStep);
            }
        }

        // Type selector (Step 1)
        document.querySelectorAll('.type-option:not(.timeline-option)').forEach(option => {
            option.addEventListener('click', function() {
                document.querySelectorAll('.type-option:not(.timeline-option)').forEach(o => o.classList.remove('selected'));
                this.classList.add('selected');

                const type = this.dataset.type;
                const isMaison = type === 'maison';

                document.getElementById('appart-fields').classList.toggle('hidden', isMaison);
                document.getElementById('maison-fields').classList.toggle('hidden', !isMaison);
                document.getElementById('maison-premium').classList.toggle('hidden', !isMaison);

                // Show/hide specific options
                document.getElementById('jardin-option').style.display = isMaison ? 'flex' : 'none';
                document.getElementById('veranda-option').style.display = isMaison ? 'flex' : 'none';
                document.getElementById('dependances-option').style.display = isMaison ? 'flex' : 'none';
                document.getElementById('portail-option').style.display = isMaison ? 'flex' : 'none';
                document.getElementById('ascenseur-option').style.display = isMaison ? 'none' : 'flex';
            });
        });

        // Timeline selector (Step 5)
        document.querySelectorAll('.timeline-option').forEach(option => {
            option.addEventListener('click', function() {
                document.querySelectorAll('.timeline-option').forEach(o => o.classList.remove('selected'));
                this.classList.add('selected');

                // Activer le bouton Suivant
                document.getElementById('step5-next-btn').disabled = false;
                log(`Timeline s√©lectionn√©e: ${this.dataset.timeline}`);
            });
        });

        // Gestion du bouton Suivant de l'√©tape 5
        function handleStep5Next() {
            const selectedOption = document.querySelector('input[name="quand_vendre"]:checked');
            if (!selectedOption) {
                alert('Veuillez s√©lectionner quand vous souhaitez vendre.');
                return;
            }

            if (selectedOption.value === 'curieux') {
                // Juste curieux -> soumettre directement le formulaire
                log('Mode curieux - soumission directe');
                submitEstimation();
            } else {
                // Projet de vente -> passer √† l'√©tape 6 (coordonn√©es)
                log('Projet de vente - passage √† l\'√©tape 6');
                currentStep = 6;
                showStep(6);
            }
        }

        // Fonction de soumission
        async function submitEstimation() {
            const form = document.getElementById('estimation-form');

            // Validate steps 1-4
            for (let i = 1; i <= 4; i++) {
                if (!validateStep(i)) {
                    log(`Validation √©chou√©e √† l'√©tape ${i}`);
                    currentStep = i;
                    showStep(i);
                    return;
                }
            }

            // R√©cup√©rer le choix de timeline
            const selectedTimelineOption = document.querySelector('input[name="quand_vendre"]:checked');
            const selectedTimeline = selectedTimelineOption ? selectedTimelineOption.value : null;

            if (!selectedTimeline) {
                alert('Veuillez s√©lectionner quand vous souhaitez vendre.');
                currentStep = 5;
                showStep(5);
                return;
            }

            const results = document.getElementById('results');
            const error = document.getElementById('error-message');

            // Cacher le formulaire et afficher les r√©sultats avec skeletons
            form.classList.add('hidden');
            error.classList.add('hidden');

            // Remettre les skeletons
            resetToSkeletons();

            // Afficher les r√©sultats (avec skeletons)
            const conversionSection = document.getElementById('conversion-section');
            if (conversionSection) conversionSection.classList.add('hidden');
            document.querySelector('.results-card').classList.remove('hidden');
            results.classList.remove('hidden');

            // Scroll vers le haut
            window.scrollTo({ top: 0, behavior: 'smooth' });

            const formData = new FormData(form);
            const data = {};

            formData.forEach((value, key) => {
                // Exclure les champs de lead du data d'estimation
                if (value !== '' && !key.startsWith('lead_')) data[key] = value;
            });

            log('Donn√©es du formulaire collect√©es', data);

            // Type conversions
            if (data.surface) data.surface = parseFloat(data.surface);
            if (data.nb_pieces) data.nb_pieces = parseInt(data.nb_pieces);
            if (data.etage) data.etage = parseInt(data.etage);
            if (data.nb_etages_immeuble) data.nb_etages_immeuble = parseInt(data.nb_etages_immeuble);
            if (data.surface_terrain) data.surface_terrain = parseFloat(data.surface_terrain);

            // Booleans
            const boolFields = ['ascenseur', 'balcon_terrasse', 'parking', 'cave', 'jardin', 'veranda',
                'dependances', 'cuisine_equipee', 'double_vitrage', 'climatisation', 'cheminee',
                'parquet', 'fibre', 'alarme', 'digicode', 'gardien', 'portail_auto',
                'piscine', 'potager', 'spa', 'terrain_tennis', 'abri_jardin', 'arrosage_auto'];
            boolFields.forEach(field => {
                data[field] = data[field] === 'true';
            });

            try {
                log('Envoi requ√™te API /api/estimate');
                const response = await fetch('/api/estimate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                log('R√©ponse API re√ßue', result);

                if (result.erreur) {
                    log('Erreur API:', result.message);
                    // R√©afficher le formulaire en cas d'erreur
                    document.getElementById('estimation-form').classList.remove('hidden');
                    document.getElementById('error-text').textContent = result.message;
                    error.classList.remove('hidden');
                } else {
                    log('Estimation r√©ussie', result);

                    window.currentEstimationResult = result;
                    displayResults(result);

                    // Si pas "juste curieux", envoyer le lead
                    if (selectedTimeline !== 'curieux') {
                        const leadNom = document.getElementById('lead-nom');
                        const leadEmail = document.getElementById('lead-email');
                        const leadTelephone = document.getElementById('lead-telephone');

                        if (leadNom && leadEmail && leadTelephone && leadNom.value && leadEmail.value) {
                            const leadData = {
                                type: 'estimation',
                                nom: leadNom.value,
                                prenom: '',
                                telephone: leadTelephone.value,
                                email: leadEmail.value,
                                projet: selectedTimeline,
                                estimation_data: {
                                    code_postal: data.code_postal,
                                    type_bien: data.type_bien,
                                    surface: data.surface,
                                    nb_pieces: data.nb_pieces,
                                    estimation_basse: result.estimation_basse,
                                    estimation_moyenne: result.estimation_moyenne,
                                    estimation_haute: result.estimation_haute
                                }
                            };

                            log('Envoi du lead...', leadData);

                            try {
                                const leadResponse = await fetch('/api/leads', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify(leadData)
                                });
                                const leadResult = await leadResponse.json();
                                log('Lead enregistr√©:', leadResult);
                            } catch (leadErr) {
                                log('Erreur envoi lead (non bloquant):', leadErr.message);
                            }
                        }
                    }

                    // Afficher les r√©sultats (le formulaire est d√©j√† cach√©)
                    const conversionSection = document.getElementById('conversion-section');
                    if (conversionSection) conversionSection.classList.add('hidden');
                    document.querySelector('.results-card').classList.remove('hidden');
                    results.classList.remove('hidden');
                }
            } catch (err) {
                log('Erreur r√©seau:', err.message);
                // Cacher les r√©sultats et r√©afficher le formulaire en cas d'erreur
                document.getElementById('results').classList.add('hidden');
                document.getElementById('estimation-form').classList.remove('hidden');
                document.getElementById('error-text').textContent = 'Erreur de connexion au serveur.';
                error.classList.remove('hidden');
            }
        }

        // Form submission
        document.getElementById('estimation-form').addEventListener('submit', function(e) {
            e.preventDefault();
            log('Soumission du formulaire...');
            submitEstimation();
        });

        function displayResults(result) {
            const formatPrice = (price) => new Intl.NumberFormat('fr-FR', {
                style: 'currency', currency: 'EUR', maximumFractionDigits: 0
            }).format(price);

            document.getElementById('result-low').textContent = formatPrice(result.estimation_basse);
            document.getElementById('result-mid').textContent = formatPrice(result.estimation_moyenne);
            document.getElementById('result-high').textContent = formatPrice(result.estimation_haute);
            document.getElementById('result-price-zone').textContent = formatPrice(result.prix_m2_zone) + '/m¬≤';
            document.getElementById('result-price-adjusted').textContent = formatPrice(result.prix_m2_ajuste) + '/m¬≤';
            document.getElementById('result-adjustment').textContent = result.ajustement_total;
            document.getElementById('result-transactions').textContent = result.nb_transactions_reference;

            const confidenceLabels = {
                'haute': 'Haute',
                'moyenne': 'Moyenne',
                'faible': 'Faible',
                'tres_faible': 'Tres faible'
            };
            document.getElementById('result-confidence').textContent = confidenceLabels[result.confiance] || result.confiance;

            // Zone info
            const zoneInfo = document.getElementById('zone-info');
            if (result.zone_elargie) {
                document.getElementById('zone-message').textContent = result.message_zone;
                zoneInfo.classList.remove('hidden');
            } else {
                zoneInfo.classList.add('hidden');
            }

            // Adjustments
            const list = document.getElementById('adjustments-list');
            list.innerHTML = '';

            const labels = {
                'etage': '√âtage', 'ascenseur': 'Ascenseur', 'etat': '√âtat',
                'balcon_terrasse': 'Balcon/Terrasse', 'parking': 'Parking',
                'cave': 'Cave', 'jardin': 'Jardin', 'dpe': 'DPE',
                'exposition': 'Exposition', 'vue': 'Vue', 'standing': 'Standing',
                'veranda': 'V√©randa', 'dependances': 'D√©pendances',
                'cuisine_equipee': 'Cuisine √©quip√©e', 'double_vitrage': 'Double vitrage',
                'climatisation': 'Climatisation', 'cheminee': 'Chemin√©e',
                'parquet': 'Parquet', 'fibre': 'Fibre optique',
                'alarme': 'Alarme', 'digicode': 'Digicode', 'gardien': 'Gardien',
                'portail_auto': 'Portail auto', 'piscine': 'Piscine', 'potager': 'Potager',
                'spa': 'Spa/Jacuzzi', 'terrain_tennis': 'Tennis',
                'abri_jardin': 'Abri jardin', 'arrosage_auto': 'Arrosage auto'
            };

            for (const [key, value] of Object.entries(result.ajustements)) {
                const li = document.createElement('li');
                li.innerHTML = `<span>${labels[key] || key}</span><span class="${value.startsWith('+') ? 'positive' : 'negative'}">${value}</span>`;
                list.appendChild(li);
            }

            if (result.valeur_terrain) {
                const li = document.createElement('li');
                li.innerHTML = `<span>Valeur terrain</span><span>${formatPrice(result.valeur_terrain)}</span>`;
                list.appendChild(li);
            }
        }

        function resetToSkeletons() {
            // Remettre les skeletons dans les valeurs
            document.getElementById('result-low').innerHTML = '<span class="skeleton skeleton-price"></span>';
            document.getElementById('result-mid').innerHTML = '<span class="skeleton skeleton-price-main"></span>';
            document.getElementById('result-high').innerHTML = '<span class="skeleton skeleton-price"></span>';
            document.getElementById('result-price-zone').innerHTML = '<span class="skeleton skeleton-detail"></span>';
            document.getElementById('result-price-adjusted').innerHTML = '<span class="skeleton skeleton-detail"></span>';
            document.getElementById('result-adjustment').innerHTML = '<span class="skeleton skeleton-detail"></span>';
            document.getElementById('result-transactions').innerHTML = '<span class="skeleton skeleton-detail"></span>';
            document.getElementById('result-confidence').innerHTML = '<span class="skeleton skeleton-detail"></span>';
            document.getElementById('adjustments-list').innerHTML = '';
        }

        function closeResults() {
            document.getElementById('results').classList.add('hidden');
        }

        function closeError() {
            document.getElementById('error-message').classList.add('hidden');
        }

        function newEstimation() {
            // Cacher les r√©sultats
            document.getElementById('results').classList.add('hidden');
            document.querySelector('.results-card').classList.add('hidden');
            const conversionSection = document.getElementById('conversion-section');
            if (conversionSection) conversionSection.classList.add('hidden');
            // Reset conversion section elements
            const estimationBanner = document.querySelector('.estimation-ready-banner');
            const estimationPreview = document.querySelector('.estimation-preview');
            const upsellSection = document.querySelector('.upsell-section');
            const skipBtn = document.getElementById('skip-conversion-btn');
            if (estimationBanner) estimationBanner.classList.remove('hidden');
            if (estimationPreview) estimationPreview.classList.remove('hidden');
            if (upsellSection) upsellSection.classList.remove('hidden');
            if (skipBtn) skipBtn.classList.remove('hidden');

            // R√©afficher le formulaire
            const form = document.getElementById('estimation-form');
            form.classList.remove('hidden');
            form.reset();
            resetLeadForms();

            // Reset multi-step form to step 1
            currentStep = 1;
            showStep(1);
            // Reset type selector to appartement
            document.querySelectorAll('.type-option:not(.timeline-option)').forEach(o => o.classList.remove('selected'));
            document.querySelector('.type-option[data-type="appartement"]').classList.add('selected');
            document.getElementById('appart-fields').classList.remove('hidden');
            document.getElementById('maison-fields').classList.add('hidden');
            document.getElementById('maison-premium').classList.add('hidden');
            // Reset √©tape 5 et 6
            document.querySelectorAll('.timeline-option').forEach(o => o.classList.remove('selected'));
            document.getElementById('step5-next-btn').disabled = true;
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function skipToEstimation() {
            // Track skip
            if (window.EITracker && window.EITracker.track) {
                window.EITracker.track('estimation_skip');
            }
            // Hide conversion section, show results
            document.getElementById('conversion-section').classList.add('hidden');
            document.querySelector('.results-card').classList.remove('hidden');
            document.querySelector('.results-card').scrollIntoView({ behavior: 'smooth', block: 'start' });
            // Track estimation view
            if (window.EITracker && window.EITracker.track) {
                window.EITracker.track('estimation_view', {
                    estimation_moyenne: window.currentEstimationResult?.estimation_moyenne
                });
            }
        }

        // Lead form functions
        function showCallbackForm() {
            // Track callback click
            if (window.EITracker && window.EITracker.track) {
                window.EITracker.track('callback_click');
            }
            document.querySelector('.estimation-ready-banner').classList.add('hidden');
            document.querySelector('.estimation-preview').classList.add('hidden');
            document.querySelector('.upsell-section').classList.add('hidden');
            document.getElementById('skip-conversion-btn').classList.add('hidden');
            document.getElementById('callback-form-container').classList.remove('hidden');
        }

        function showVisitForm() {
            // Track visit click
            if (window.EITracker && window.EITracker.track) {
                window.EITracker.track('visit_click');
            }
            document.querySelector('.estimation-ready-banner').classList.add('hidden');
            document.querySelector('.estimation-preview').classList.add('hidden');
            document.querySelector('.upsell-section').classList.add('hidden');
            document.getElementById('skip-conversion-btn').classList.add('hidden');
            document.getElementById('visit-form-container').classList.remove('hidden');
            // Set min date to today
            document.getElementById('visit-date').min = new Date().toISOString().split('T')[0];
        }

        function hideLeadForms() {
            document.getElementById('callback-form-container').classList.add('hidden');
            document.getElementById('visit-form-container').classList.add('hidden');
            document.querySelector('.estimation-ready-banner').classList.remove('hidden');
            document.querySelector('.estimation-preview').classList.remove('hidden');
            document.querySelector('.upsell-section').classList.remove('hidden');
            document.getElementById('skip-conversion-btn').classList.remove('hidden');
        }

        function resetLeadForms() {
            hideLeadForms();
            document.getElementById('lead-success').classList.add('hidden');
            document.getElementById('callback-form').reset();
            document.getElementById('visit-form').reset();
        }

        // Get current estimation data
        function getCurrentEstimation() {
            return {
                code_postal: document.getElementById('code_postal').value,
                type_bien: document.querySelector('input[name="type_bien"]:checked')?.value,
                surface: document.getElementById('surface').value,
                nb_pieces: document.getElementById('nb_pieces').value,
                estimation_basse: document.getElementById('result-low').textContent,
                estimation_moyenne: document.getElementById('result-mid').textContent,
                estimation_haute: document.getElementById('result-high').textContent
            };
        }

        // Callback form submission
        document.getElementById('callback-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            log('Soumission formulaire callback...');

            const formData = new FormData(this);
            const data = {
                type: 'callback',
                nom: formData.get('nom'),
                prenom: formData.get('prenom'),
                telephone: formData.get('telephone'),
                email: formData.get('email') || null,
                horaires: formData.get('horaires'),
                projet: formData.get('projet'),
                estimation_data: getCurrentEstimation(),
                date_demande: new Date().toISOString()
            };

            log('Donn√©es lead callback:', data);

            try {
                // Send to backend API
                log('Envoi vers /api/leads...');
                const response = await fetch('/api/leads', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                log('R√©ponse /api/leads:', result);

                if (!response.ok) throw new Error(result.message || 'Erreur serveur');

                // Track callback submit
                if (window.EITracker && window.EITracker.track) {
                    window.EITracker.track('callback_submit', { projet: data.projet });
                }

                // Show success then estimation
                document.getElementById('callback-form-container').classList.add('hidden');
                document.getElementById('lead-success').classList.remove('hidden');
                document.getElementById('success-message').textContent =
                    'Un conseiller vous rappellera sur le ' + data.telephone;

                // Show estimation after delay
                setTimeout(function() {
                    document.getElementById('conversion-section').classList.add('hidden');
                    document.querySelector('.results-card').classList.remove('hidden');
                    document.querySelector('.results-card').scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 2000);

            } catch (err) {
                // Fallback: store locally
                const leads = JSON.parse(localStorage.getItem('valomaison_leads') || '[]');
                leads.push(data);
                localStorage.setItem('valomaison_leads', JSON.stringify(leads));

                // Track callback submit (fallback)
                if (window.EITracker && window.EITracker.track) {
                    window.EITracker.track('callback_submit', { projet: data.projet, fallback: true });
                }

                document.getElementById('callback-form-container').classList.add('hidden');
                document.getElementById('lead-success').classList.remove('hidden');
                document.getElementById('success-message').textContent =
                    'Demande enregistr√©e ! Un conseiller vous rappellera bient√¥t.';

                // Show estimation after delay
                setTimeout(function() {
                    document.getElementById('conversion-section').classList.add('hidden');
                    document.querySelector('.results-card').classList.remove('hidden');
                    document.querySelector('.results-card').scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 2000);
            }
        });

        // Visit form submission
        document.getElementById('visit-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            log('Soumission formulaire visite...');

            const formData = new FormData(this);
            const data = {
                type: 'visit',
                nom: formData.get('nom'),
                prenom: formData.get('prenom'),
                telephone: formData.get('telephone'),
                email: formData.get('email'),
                adresse: formData.get('adresse'),
                date_souhaitee: formData.get('date'),
                creneau: formData.get('creneau'),
                message: formData.get('message') || null,
                estimation_data: getCurrentEstimation(),
                date_demande: new Date().toISOString()
            };

            log('Donn√©es lead visite:', data);

            try {
                // Send to backend API
                log('Envoi vers /api/leads...');
                const response = await fetch('/api/leads', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                log('R√©ponse /api/leads:', result);

                if (!response.ok) throw new Error(result.message || 'Erreur serveur');

                // Track visit submit
                if (window.EITracker && window.EITracker.track) {
                    window.EITracker.track('visit_submit');
                }

                // Show success then estimation
                document.getElementById('visit-form-container').classList.add('hidden');
                document.getElementById('lead-success').classList.remove('hidden');
                document.getElementById('success-message').textContent =
                    'Visite programm√©e ! Vous recevrez une confirmation par email √† ' + data.email;

                // Show estimation after delay
                setTimeout(function() {
                    document.getElementById('conversion-section').classList.add('hidden');
                    document.querySelector('.results-card').classList.remove('hidden');
                    document.querySelector('.results-card').scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 2000);

            } catch (err) {
                // Fallback: store locally
                const leads = JSON.parse(localStorage.getItem('valomaison_leads') || '[]');
                leads.push(data);
                localStorage.setItem('valomaison_leads', JSON.stringify(leads));

                // Track visit submit (fallback)
                if (window.EITracker && window.EITracker.track) {
                    window.EITracker.track('visit_submit', { fallback: true });
                }

                document.getElementById('visit-form-container').classList.add('hidden');
                document.getElementById('lead-success').classList.remove('hidden');
                document.getElementById('success-message').textContent =
                    'Demande de visite enregistr√©e ! Un conseiller vous contactera pour confirmer.';

                // Show estimation after delay
                setTimeout(function() {
                    document.getElementById('conversion-section').classList.add('hidden');
                    document.querySelector('.results-card').classList.remove('hidden');
                    document.querySelector('.results-card').scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 2000);
            }
        });
    </script>
    <script src="{{ url_for('static', filename='tracker.js') }}" defer></script>
</body>
</html>
